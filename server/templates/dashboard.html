<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fountaine MTR Dashboard</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .server-time {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--light);
            padding: 12px 20px;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 992px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #219a52;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .messages-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        
        .nav-tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom-color: white;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .canvas-container {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            height: 600px;
        }
        
        #cvcont {
            width: 100%;
            height: 100%;
            background-color: #f8f9fa;
        }
        
        .canvas-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        
        .canvas-controls .btn {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .signal-status {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-green {
            background-color: var(--success);
        }
        
        .status-orange {
            background-color: var(--warning);
        }
        
        .status-red {
            background-color: var(--danger);
        }
        
        .quick-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .quick-link {
            color: var(--secondary);
            text-decoration: none;
            padding: 5px 10px;
            border: 1px solid var(--secondary);
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .quick-link:hover {
            background-color: var(--secondary);
            color: white;
        }
        
        .batch-process {
            border-left: 4px solid var(--secondary);
            padding-left: 15px;
            margin-top: 20px;
        }
        
        .step {
            margin-bottom: 20px;
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input {
            margin-right: 8px;
        }
        
        .result-box {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            min-height: 100px;
            margin-top: 10px;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .progress-bar {
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .signal-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .signal-controls {
                grid-template-columns: 1fr;
            }
        }
		
		.tooltip {
			position: absolute;
			background-color: rgba(0, 0, 0, 0.8);
			color: white;
			padding: 8px 12px;
			border-radius: 4px;
			font-size: 14px;
			pointer-events: none;
			z-index: 100;
			max-width: 300px;
			white-space: nowrap;
			display: none;
		}

		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			z-index: 1000;
			justify-content: center;
			align-items: center;
		}

		.modal-content {
			background-color: white;
			padding: 20px;
			border-radius: 8px;
			width: 90%;
			max-width: 500px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
		}

		.modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 1px solid #eee;
		}

		.modal-title {
			font-weight: 600;
			font-size: 18px;
		}

		.close-btn {
			background: none;
			border: none;
			font-size: 24px;
			cursor: pointer;
			color: #777;
		}

		.modal-body {
			margin-bottom: 20px;
		}

		.modal-footer {
			display: flex;
			justify-content: flex-end;
			gap: 10px;
		}

		.segment-info {
			background-color: #f8f9fa;
			padding: 10px;
			border-radius: 4px;
			margin-bottom: 15px;
		}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">Fountaine MTR Dashboard</div>
                <div class="server-time">Server Time: <span id="srvt">Loading...</span></div>
            </div>
        </header>
        
        <div class="grid">
            <!-- 消息和系统状态 -->
            <div class="card full-width">
                <div class="card-header">
                    <span>System State and Messages</span>
                    <button class="btn btn-danger" onclick="clean();">Clear</button>
                </div>
                <div class="card-body">
                    <div class="messages-container" id="msgs">
                        <!-- 消息将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
            
            <!-- 信号控制 -->
            <div class="card">
                <div class="card-header">Signal Control</div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>Tip:</strong> Input signal name and target state (description or diverging target). Don't forget password.
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="spwd">Password</label>
                        <input type="password" id="spwd" class="form-control" placeholder="Input your password here...">
                    </div>
                    
                    <div class="signal-controls">
                        <div class="form-group">
                            <label class="form-label" for="sname">Signal Name</label>
                            <input type="text" id="sname" class="form-control" placeholder="Signal Name">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="stype">Target State</label>
                            <input type="text" id="stype" class="form-control" placeholder="Target State (e.g. '5', '.', '0', 'M_up3')">
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="go();">Apply</button>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label">Result</label>
                        <div class="result-box" id="result"></div>
                    </div>
                </div>
            </div>
            
            <!-- 线路图 -->
            <div class="card">
                <div class="card-header">
                    <span>Line Map</span>
                    <div class="signal-status">
                        <div class="status-indicator status-green"></div>
                        <span>Clear</span>
                        <div class="status-indicator status-orange" style="margin-left: 15px;"></div>
                        <span>Restricted</span>
                        <div class="status-indicator status-red" style="margin-left: 15px;"></div>
                        <span>Occupied/Danger</span>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="canvas-container">
                        <canvas id="cvcont" width="3200" height="3200"></canvas>
                        <div class="canvas-controls">
							<button class="btn" onclick="resetScale()">Reset Zoom</button>
							<button class="btn" onclick="toggleSegmentInfo()">Toggle Segment Info</button>
						</div>
                    </div>
                </div>
            </div>
            
            <!-- 快速链接和批量处理 -->
            <div class="card">
                <div class="card-header">Utilities</div>
                <div class="card-body">
                    <div class="quick-links">
                        <a href="/befehlgui" target="_blank" class="quick-link">Shunting Command</a>
                        <a href="/signaldisp" target="_blank" class="quick-link">Signal Display (Alternative)</a>
                        <a href="/signaladdisp" target="_blank" class="quick-link">Additional Information</a>
                        <a href="javascript:;" class="quick-link" onclick="toggleBatchProcess()">Batch Process</a>
                    </div>
                    
                    <div class="batch-process" id="batch_proc" style="display: none;">
                        <div class="alert alert-warning">
                            Tip: Batch Process allows you to configure multiple signals.
                        </div>
                        
                        <div class="step">
                            <div class="step-title">Step 1: Select Path</div>
                            <div class="form-group">
                                <label class="form-label" for="sgvon">From: </label>
                                <input type="text" id="sgvon" class="form-control" placeholder="Input Signal Name">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="sgnach">To: </label>
                                <input type="text" id="sgnach" class="form-control" placeholder="Input Signal Name">
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="no_red">
                                <label for="no_red">Avoid signals at Danger</label>
                            </div>
                            <button class="btn" onclick="generatePath();">Generate Path</button>
                        </div>
                        
                        <div class="step">
                            <div class="step-title">Step 2: Specify Signals</div>
                            <div class="form-group">
                                <label class="form-label" for="sgnames">Signal List (split by comma)</label>
                                <textarea id="sgnames" class="form-control" rows="4" placeholder="Input Signal Names split by (','). This text may be automatically generated by the previous step."></textarea>
                            </div>
                        </div>
                        
                        <div class="step">
                            <div class="step-title">Step 3: Take Action</div>
                            <div class="checkbox-group">
                                <input type="radio" id="diverg_mode" name="exec_mode">
                                <label for="diverg_mode">Configure diverging as the given order in the previous step</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="radio" id="signal_mode" name="exec_mode">
                                <label for="signal_mode">Configure all signals as:</label>
                                <input type="text" id="signal_conf" class="form-control" style="width: 100px; margin-left: 10px;">
                            </div>
                            <button class="btn btn-success" onclick="proceed()">Execute</button>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress" id="progress-bar"></div>
                        </div>
                        <div id="progress" style="color: green; font-size: 14px;"></div>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">Result</label>
                            <div class="result-box" id="execresult"></div>
                            <button class="btn" onclick="document.getElementById('execresult').innerHTML = '';" style="margin-top: 10px;">Clear Result</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
	
		var hoveredSegment = null;
		var tooltip = document.createElement('div');
		tooltip.className = 'tooltip';
		document.body.appendChild(tooltip);
	
        // 原有JavaScript代码保持不变，只添加了toggleBatchProcess函数
        function toggleBatchProcess() {
            var batchProc = document.getElementById('batch_proc');
            if (batchProc.style.display === 'none') {
                batchProc.style.display = 'block';
                document.getElementById('progress').innerHTML = '';
            } else {
                batchProc.style.display = 'none';
            }
        }
        
        // 原有JavaScript代码
        // Refer to server python file !!!
        const SERVER_ZOOM = 250;
        const infdist = 1e15;

        // Thanks to bing.
        var isDragging = false, startX, startY, scale = 1;
        const scaleFactor = 1.1;
        
        var cmousex = 0, cmousey = 0, ctransx = 0, ctransy = 0;

        // Move before resize !!
        var MAP_MOVE_X = 820, MAP_MOVE_Y = 300, MAP_RESIZE_X = 1, MAP_RESIZE_Y = 1;

        function isdigit(x) {
            return /^\d+$/.test(x);
        }

        function xmv(x) {
            return (x+MAP_MOVE_X)*MAP_RESIZE_X;
        }
    
        function ymv(y) {
            return (y+MAP_MOVE_Y)*MAP_RESIZE_Y;
        }
    
        function sigcolor(xsigstr) {
            var sigstr = xsigstr.trim();
            if (sigstr == "0") return "red";
            if (isdigit(sigstr)) return "orange";
            switch (sigstr) {
                case '.':
                    return 'green';
                    break;
                case '/': case '|': case '<': case '>':
                    return 'orange';
                    break;
                default:
                    return 'red';
                    break;
            }
        }
    
        var cxhrtext = [];
        var signals = {}, sigtotal = 0;

        //xhr.responseText
        function systemRedraw(xhrtext) {
            if (xhrtext == undefined) xhrtext = cxhrtext;
            cxhrtext = xhrtext;// Auto caching
            var cd = document.getElementById('cvcont');
            var cv = cd.getContext('2d');
            cv.lineWidth = 4;
            // 彻底清除画布，解决重影问题
			cv.setTransform(1, 0, 0, 1, 0, 0);
			cv.clearRect(0, 0, cd.width, cd.height);
			
			// 应用当前变换
			cv.scale(scale, scale);
			cv.translate(ctransx/scale, ctransy/scale);
            var xrt = xhrtext;
            for (let i = 0; i < xrt.length; i++) {
                if (xrt[i].trim() == "") continue;
                let crt = xrt[i].split(" ");
                let xb = xmv(parseInt(crt[1])), yb = ymv(parseInt(crt[2]));
                let xe = xmv(parseInt(crt[3])), ye = ymv(parseInt(crt[4]));
                cv.beginPath();
                cv.moveTo(xb, yb);
                cv.lineTo(xe, ye);
                let csc = sigcolor(crt[5]);
                cv.strokeStyle = csc;
                cv.fillStyle = csc;
                //if (csc != 'green' || crt[8] != "*") {
                //}
                if (cmousex >= Math.min(xb,xe) && cmousex <= Math.max(xb,xe) && cmousey >= Math.min(yb,ye) && cmousey <= Math.max(yb,ye)) {
                    let zu = "";
                    if (crt.length >= 10) zu = " " + crt[9];
                    cv.fillText(crt[0] + ": " + crt[5] + " & " + crt[8] + zu, (xb+xe)/2, (yb+ye)/2);
                    console.log("Moving to " + crt[0])
                }
                cv.stroke();
            }
        
        }
        setInterval(function() {
            systemRedraw();
        }, 100);
    
        setInterval(function() {
        // Not supported for server with high stress.
        /*
            var v = document.getElementById('imgcont');
            v.innerHTML = "";
            var ig = document.createElement('img');
            ig.src = "/state?heartbeat=" + Math.random();
            v.appendChild(ig);
        */
            //systemRedraw();
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/signalstates');
            xhr.send(null);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    systemRedraw(xhr.responseText.split("\n"));
                }
            };
        }, 2000);
        setInterval(function() {
            var v = document.getElementById('srvt');
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/msg?mode=zeit');
            xhr.send(null);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) v.innerHTML = xhr.responseText;
            };
        }, 500);
        setInterval(function() {
            var v = document.getElementById('msgs');
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/msg?mode=warnung');
            xhr.send(null);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) v.innerHTML = xhr.responseText;
            };
        }, 2000);
        function go() {
            var xhr = new XMLHttpRequest();
            var sn = document.getElementById('sname');
            var st = document.getElementById('stype');
            var sp = document.getElementById('spwd');
            if ((!isdigit(st.value)) && st.value.length > 1) {
                xhr.open('GET', "/diverg?sid=" + sn.value + "&stat=" + st.value + "&auth=" + sp.value);
            } else {
                xhr.open('GET', "/signalset?sid=" + sn.value + "&stat=" + st.value + "&auth=" + sp.value);
            }
        
            xhr.send(null);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) document.getElementById('result').innerHTML = xhr.responseText;
                if (xhr.responseText == "?") alert("Password might be wrong.");
            };
        }
        function clean() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/msg?mode=clr');
            xhr.send(null);
        }
        function render(id) {
            document.getElementById(id).style.display = "block";
        }
        function unRender(id) {
            document.getElementById(id).style.display = "none";
        }
    
        // Generate path by using O(n^2) dijkstra.
        // Unless Zhongli or Jean give me 100 000 mora, I will not
        // optimize this.

        function loadAsSignals() {
            var signals_raw = cxhrtext;
            signals = {};
            sigtotal = 0;
            for (let i = 0; i < signals_raw.length; i++) {
                let scur = signals_raw[i];
                if (scur.trim() == "") continue;
                try {
                    let skv = scur.split(" ", 1);
                    let scpos = scur.indexOf(" ");
                    if (scpos < 0) {
                        throw "Unexpected format!"
                    }
                    let skdata = scur.slice(scpos + 1).split(" ");
                    signals[skv[0]] = skdata;   // NOTICES THAT THEY ARE ALL STRINGS
                    signals[skv[0]][5] = signals[skv[0]][5].split(",");
                    for (let j = 0; j < 4; j++) {
                        signals[skv[0]][j] = parseInt(signals[skv[0]][j]);
                    }
                    sigtotal++; // So that malfunctioning ones won't be added
                } catch (e) {
                    console.log(e);
                }
            }
        }

        function distanceBetween(x1, y1, x2, y2) {
            return Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
        }

        function generatePath() {
            if (cxhrtext.length <= 0) {
                alert("Data of signals are not ready, please wait for fetching.");
                return;
            }
            var signal_graph = {}, dist = {}, zu = {}, visited = {};
            var von = document.getElementById('sgvon').value;
            var nach = document.getElementById('sgnach').value;
            var skip_danger = document.getElementById('no_red').checked;
            var finalta = document.getElementById('sgnames');
            // 1. Unload as dictionary
            loadAsSignals();
            // 2. Load distances
            for (let i in signals) {
                signal_graph[i] = {};
            }
            for (let i in signals) {
                dist[i] = infdist;
                if (signals[i][4] == "0" && skip_danger) continue;
                /*if (!(i in dist)) {
                    signal_graph[i] = {};
                }*/
                let mydist = distanceBetween(signals[i][0], signals[i][1], signals[i][2], signals[i][3]);
                for (let j = 0; j < signals[i][5].length; j++) {
                    //dist[i][signals[i][5]]
                    let t = signals[i][5][j];
                    if (signals[t][4] == "0" && skip_danger) continue;
                    let aliendist = mydist + distanceBetween(signals[i][2], signals[i][3], signals[t][0], signals[t][1]);
                    signal_graph[i][t] = aliendist;
                }
            }
            dist[von] = 0;
            //visited[von] = true;
            zu[von] = "";   // i.e., null.
            for (let i = 0; i < sigtotal; i++) {
                let minsig = "", minval = infdist;
                for (let j in dist) {
                    if ((!(j in visited)) && (dist[j] < minval)) {
                        minval = dist[j];
                        minsig = j;
                    }
                }
                if (minsig == "") break;
                visited[minsig] = true;
                for (let j in signal_graph[minsig]) {
                    let newdist = minval + signal_graph[minsig][j];
                    if (newdist < dist[j]) {
                        dist[j] = newdist;
                        zu[j] = minsig;
                    }
                }
            }
            if (!(nach in zu)) {
                alert("Failed to find a route!");
                return;
            }
            var result = "", cur = nach;
            while (zu[cur] != "") {
                result = ", " + cur + result;
                cur = zu[cur];
            }
            result = von + result;
            finalta.value = result;
        }

        var exec_result = "";
        var exec_target = [], exec_para = null;

        function end_diverg() {
            document.getElementById('progress').innerHTML = "Complete!";
            document.getElementById('execresult').innerHTML = exec_result;
            document.getElementById('progress-bar').style.width = '100%';
        }

        function end_signal() {
            document.getElementById('progress').innerHTML = "Complete!";
            document.getElementById('execresult').innerHTML = exec_result;
            document.getElementById('progress-bar').style.width = '100%';
        }

        function set_diverg(n) {
            if (n >= exec_target.length - 1) {
                end_diverg();
                return;
            }
            document.getElementById('progress').innerHTML = n + " / " + (exec_target.length - 1) + " Completed";
            document.getElementById('progress-bar').style.width = (n / (exec_target.length - 1) * 100) + '%';
            var xhr = new XMLHttpRequest();
            var sp = document.getElementById('spwd');
            xhr.open('GET', "/diverg?sid=" + exec_target[n] + "&stat=" + exec_target[n+1] + "&auth=" + sp.value);
            xhr.send(null);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    exec_result += exec_target[n] + ": " + xhr.responseText + "<br>";
                    set_diverg(n + 1);
                }
            }
        }

        function set_signal(n) {
            if (n >= exec_target.length) {
                end_signal();
                return;
            }
            var xhr = new XMLHttpRequest();
            document.getElementById('progress').innerHTML = n + " / " + (exec_target.length) + " Completed";
            document.getElementById('progress-bar').style.width = (n / exec_target.length * 100) + '%';
            var sp = document.getElementById('spwd');
            xhr.open('GET', "/signalset?sid=" + exec_target[n] + "&stat=" + exec_para + "&auth=" + sp.value);
            xhr.send(null);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    exec_result += exec_target[n] + ": " + xhr.responseText + "<br>";
                    set_signal(n + 1);
                }
            }
        }

        function proceed() {
            exec_result = "";
            document.getElementById('progress-bar').style.width = '0%';
            exec_target = document.getElementById('sgnames').value.split(",");
            for (let i = 0; i < exec_target.length; i++) {
                exec_target[i] = exec_target[i].trim();
            }
            if (document.getElementById('diverg_mode').checked) {
                set_diverg(0);
            } else if (document.getElementById('signal_mode').checked) {
                exec_para = document.getElementById('signal_conf').value;
                set_signal(0);
            } else {
                alert("Please set configuration mode from 2 options first!");
            }
        }
        window.onload = function() {
            var canvas = document.getElementById('cvcont');
            var ctx = canvas.getContext('2d');
    
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.offsetX;
                startY = e.offsetY;
            });
			/*
            canvas.addEventListener('mousemove', (e) => {
                var rect = canvas.getBoundingClientRect();
                var scaleX = canvas.width / rect.width;
                var scaleY = canvas.height / rect.height;

                cmousex = (e.clientX - rect.left - ctransx) / scale; 
                cmousey = (e.clientY - rect.top - ctransy) / scale;
				
				 // 转换为Canvas坐标系（考虑缩放和平移）
				var canvasX = (cmousex - ctransx) / scale;
				var canvasY = (cmousey - ctransy) / scale;
				
                if (isDragging) {
                    const dx = e.offsetX - startX;
                    const dy = e.offsetY - startY;
                    ctx.translate(dx, dy);
                    ctransx += dx * scale;
                    ctransy += dy * scale;
                    startX = e.offsetX;
                    startY = e.offsetY;
                    systemRedraw();
                } else {
					// 检测悬停的区段
					hoveredSegment = null;
					var xrt = cxhrtext;
					for (let i = 0; i < xrt.length; i++) {
						if (xrt[i].trim() == "") continue;
						let crt = xrt[i].split(" ");
						let xb = xmv(parseInt(crt[1])), yb = ymv(parseInt(crt[2]));
						let xe = xmv(parseInt(crt[3])), ye = ymv(parseInt(crt[4]));
						
						// 更精确的线段悬停检测
						if (isPointNearLine(canvasX, canvasY, xb, yb, xe, ye, 10)) {
							hoveredSegment = crt;
							break;
						}
					}
					
					// 显示或隐藏工具提示
					if (hoveredSegment) {
						let zu = "";
						if (hoveredSegment.length >= 10) zu = " " + hoveredSegment[9];
						tooltip.innerHTML = hoveredSegment[0] + ": " + hoveredSegment[5] + " & " + hoveredSegment[8] + zu;
						tooltip.style.display = 'block';
						tooltip.style.left = (e.clientX + 10) + 'px';
						tooltip.style.top = (e.clientY + 10) + 'px';
					} else {
						tooltip.style.display = 'none';
					}
				}
            });
			*/
			canvas.addEventListener('mousemove', (e) => {
				var rect = canvas.getBoundingClientRect();
				var scaleX = canvas.width / rect.width;
				var scaleY = canvas.height / rect.height;
				
				// 正确计算鼠标在画布上的实际位置（考虑缩放和平移）
				var mouseCanvasX = (e.clientX - rect.left) * scaleX;
				var mouseCanvasY = (e.clientY - rect.top) * scaleY;
				
				// 转换为画布变换后的坐标系
				cmousex = (mouseCanvasX - ctransx) / scale;
				cmousey = (mouseCanvasY - ctransy) / scale;
				
				// 更新全局变量用于其他函数
				window.cmousex = cmousex;
				window.cmousey = cmousey;
				
				if (isDragging) {
					const dx = e.offsetX - startX;
					const dy = e.offsetY - startY;
					ctx.translate(dx, dy);
					ctransx += dx * scale;
					ctransy += dy * scale;
					startX = e.offsetX;
					startY = e.offsetY;
					systemRedraw();
				} else {
					// 检测悬停的区段 - 使用正确的坐标系统
					hoveredSegment = null;
					var xrt = cxhrtext;
					for (let i = 0; i < xrt.length; i++) {
						if (xrt[i].trim() == "") continue;
						let crt = xrt[i].split(" ");
						let xb = xmv(parseInt(crt[1])), yb = ymv(parseInt(crt[2]));
						let xe = xmv(parseInt(crt[3])), ye = ymv(parseInt(crt[4]));
						
						// 使用正确的坐标进行悬停检测
						if (isPointNearLine(cmousex, cmousey, xb, yb, xe, ye, 15 / scale)) { // 阈值随缩放调整
							hoveredSegment = crt;
							break;
						}
					}
					
					// 显示或隐藏工具提示
					if (hoveredSegment) {
						let zu = "";
						if (hoveredSegment.length >= 10) zu = " " + hoveredSegment[9];
						tooltip.innerHTML = hoveredSegment[0] + ": " + hoveredSegment[5] + " & " + hoveredSegment[8] + zu;
						tooltip.style.display = 'block';
						tooltip.style.left = (e.clientX + 10 + window.scrollX) + 'px';
						tooltip.style.top = (e.clientY + 10 + window.scrollY) + 'px';
					} else {
						tooltip.style.display = 'none';
					}
				}
			});

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
                systemRedraw();
            });
			
			canvas.addEventListener('mouseleave', () => {
				tooltip.style.display = 'none';
				hoveredSegment = null;
			});

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const mouseX = e.offsetX;
                const mouseY = e.offsetY;
                ctx.translate(mouseX, mouseY);
                ctransx += mouseX * scale;
                ctransy += mouseY * scale;
                if (e.deltaY < 0) {
                    scale *= scaleFactor;
                    ctx.scale(scaleFactor, scaleFactor);
                } else {
                    scale /= scaleFactor;
                    ctx.scale(1/scaleFactor, 1/scaleFactor);
                }
                
                ctx.translate(-mouseX, -mouseY);
                ctransx -= mouseX * scale;
                ctransy -= mouseY * scale;
                systemRedraw();
            });
			
			// 添加Canvas点击事件
			canvas.addEventListener('click', (e) => {
				if (hoveredSegment) {
					// 显示操作模态框
					showSegmentModal(hoveredSegment);
				}
			});
        };
        function resetScale() {
            var canvas = document.getElementById('cvcont');
            var ctx = canvas.getContext('2d');
            ctx.translate(0, 0);
            ctx.scale(1 / scale, 1 / scale);
            scale = 1;
        }
				
		// 添加点到线段距离检测函数
		function isPointNearLine(px, py, x1, y1, x2, y2, threshold) {
			// 计算点到线段的距离
			var A = px - x1;
			var B = py - y1;
			var C = x2 - x1;
			var D = y2 - y1;

			var dot = A * C + B * D;
			var len_sq = C * C + D * D;
			var param = -1;
			if (len_sq != 0) param = dot / len_sq;

			var xx, yy;

			if (param < 0) {
				xx = x1;
				yy = y1;
			} else if (param > 1) {
				xx = x2;
				yy = y2;
			} else {
				xx = x1 + param * C;
				yy = y1 + param * D;
			}

			var dx = px - xx;
			var dy = py - yy;
			return Math.sqrt(dx * dx + dy * dy) < threshold;
		}
		/*
		// A new version is like: (I can't really understand)
function isPointNearLine(px, py, x1, y1, x2, y2, threshold) {
    // 计算点到线段的距离
    var A = px - x1;
    var B = py - y1;
    var C = x2 - x1;
    var D = y2 - y1;

    var dot = A * C + B * D;
    var len_sq = C * C + D * D;
    var param = -1;
    if (len_sq != 0) param = dot / len_sq;

    var xx, yy;

    if (param < 0) {
        xx = x1;
        yy = y1;
    } else if (param > 1) {
        xx = x2;
        yy = y2;
    } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
    }

    var dx = px - xx;
    var dy = py - yy;
    return Math.sqrt(dx * dx + dy * dy) < threshold;
}
		*/
		/*
		3. 添加点击操作功能
		添加Canvas点击事件处理，并创建操作模态框：
		*/

		// 显示区段操作模态框
		function showSegmentModal(segmentData) {
			document.getElementById('modalSegmentId').textContent = segmentData[0];
			document.getElementById('modalSegmentStatus').textContent = segmentData[5];
			let zu = "";
			if (hoveredSegment.length >= 10) zu = " " + hoveredSegment[9];
			document.getElementById('modalSegmentDiverg').textContent = segmentData[8] + zu;
			
			// 预填充操作表单
			document.getElementById('sname').value = segmentData[0];
			
			// 显示模态框
			document.getElementById('segmentModal').style.display = 'flex';
			
			const checking = ["red", "orange", "green"];
			for (let i = 0; i < checking.length; i++) {
				let sts = "status-" + checking[i];
				if (document.getElementById('segmentInd').classList.contains(sts)) {
					document.getElementById('segmentInd').classList.remove(sts);
				}
			}
			document.getElementById('segmentInd').classList.add("status-" + sigcolor(segmentData[5]));
		}

		// 关闭模态框
		function closeSegmentModal() {
			document.getElementById('segmentModal').style.display = 'none';
		}

		// 应用区段操作
		function applySegmentAction() {
			var actionType = document.getElementById('modalSegmentAction').value;
			var value = document.getElementById('modalSegmentValue').value;
			var sid = document.getElementById('modalSegmentId').textContent;
			var auth = document.getElementById('spwd').value;
			
			var endpoint = actionType === 'signal' ? '/signalset' : '/diverg';
			var xhr = new XMLHttpRequest();
			xhr.open('GET', endpoint + "?sid=" + sid + "&stat=" + value + "&auth=" + auth);
			xhr.send(null);
			xhr.onreadystatechange = function() {
				if (xhr.readyState == 4) {
					document.getElementById('result').innerHTML = xhr.responseText;
					if (xhr.responseText == "?") alert("密码可能错误。");
					closeSegmentModal();
				}
			};
		}
		
		function toggleSegmentInfo() {
			var tooltip = document.querySelector('.tooltip');
			if (tooltip.style.display === 'none') {
				tooltip.style.display = 'block';
			} else {
				tooltip.style.display = 'none';
			}
		}
    </script>
	<div class="modal" id="segmentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Signal Operation</h3>
            <button class="close-btn" onclick="closeSegmentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="segment-info">
                <p><strong>Signal Name:</strong> <span id="modalSegmentId">-</span></p>
				<div class="signal-status">
					<p><strong>Current State:</strong> <span id="modalSegmentStatus">-</span></p>
					<div class="status-indicator" id="segmentInd" style="margin-left: 15px;"></div>
                </div>
                <p><strong>Occupied By:</strong> <span id="modalSegmentDiverg">-</span></p>
            </div>
            <div class="form-group">
                <label class="form-label" for="modalSegmentAction">Select Operation:</label>
                <select id="modalSegmentAction" class="form-control">
                    <option value="signal">Configure signal state</option>
                    <option value="diverg">Configure diverging</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="modalSegmentValue">As:</label>
                <input type="text" id="modalSegmentValue" class="form-control" placeholder="Input target state...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeSegmentModal()">Cancel</button>
            <button class="btn btn-success" onclick="applySegmentAction()">Apply</button>
        </div>
    </div>
</div>
</body>
</html>